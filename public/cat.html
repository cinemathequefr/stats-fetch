<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>


var cats = [
  ["Plein tarif", [1862472, 1862556, 1863732, 1863768, 1863774, 1863784, 1897466, 1968658, 2239989, 2480231]],
  ["Libre pass", [1862470, 1862576, 1863730, 1863782, 1897476, 1897504, 1968650, 2299203]],
  ["Exonéré", [1861566, 1861702, 1862480, 1862482, 1862484, 1862502, 1862510, 1863738, 1863740, 1863742, 1863750, 1863752, 1863790, 1863792, 1863794, 1863810, 1863822, 1863842, 1864746, 1865350, 1865352, 1865962, 1906780, 1968672, 1968678, 2002701, 2197595]],
  ["Forfait 6 places", [1862474, 1862558, 1935254, 2319747]],
  ["Moins de 26 ans", [1862476, 1863736, 1863786, 1897470, 1897500, 2239993, 2299187, 2299299]],
  ["Moins de 18 ans", [1862486, 1862538, 1862548, 1863766, 1863838, 1864688, 1864744, 2197665, 2197669, 2311187, 2508607]],
  ["Cinéfamille adulte", [1862488, 1862570, 1863744, 1863798]],
  ["Cinéfamille enfant", [1862498, 1862574]],
  ["Groupe adulte", [1872138, 1881538, 1881886, 1881892, 2212393]],
  ["Groupe enfant", [1881506, 1881512, 1881684, 1914582, 2292151, 2300095, 2300097]],
  ["Partenariats et promotion", [1862514, 1862520, 1862522, 1862528, 1862530, 1862532, 1862534, 1862554, 1862578, 1862580, 1862582, 1862584, 1862586, 1863756, 1863760, 1863762, 1863824, 1863830, 1863834, 1968670, 1968694, 1968712, 1968716, 1968740, 2020347, 2200009, 2212387, 2225849, 2311121, 2311123, 2315127, 2458625]]
];
var tarif = {"1862470":116,"1862472":17,"1862476":6,"1862478":2,"1862480":2,"1862482":2,"1862484":2,"1862486":4,"1862504":4,"1862516":1,"1862538":1,"1862556":2,"2319747":15};


$(() => {
  $("code").html(JSON.stringify(tarifCat(tarif, cats), 2, 2));
});

console.log(tarifCat(tarif, cats));


/**
  * tarifCat
  * A partir de nombres de billets vendus par code tarifaire, on obtient le nombre de billets vendus par catégorie tarifaire (regroupement de codes tarifaires)
  * @param tarif {Object} Objet avec {code tarifaire: nombre de billets vendus, ...}
  * @param cats {Array} Liste ordonnée de [intitulé de catégorie tarifaire,  [code tarifaire, ...]]
  * @return {Array} Liste [[intitulé de catégorie tarifaire, nombre de billet vendus], ...]
  * NB: moins élégant que la solution initiale (cf infra), mais l'utilisation d'une tableau pour `cats` permet d'obtenir une sortie dans le même ordre
  * alors que l'utilisation d'un objet obligerait à une étape supplémentaire pour s'assurer de l'ordre de sortie
  */
function tarifCat (tarif, cats) {
  return _(
    _(tarif)
    .map((v, k) => {
      var r = _(cats).find(c => _.indexOf(c[1], parseInt(k, 10)) > - 1);
      return [r ? r[0] : "Autres", v];
    })
    .reduce((acc, item) => {
      var index = _(acc).findIndex(i => i[0] === item[0]);
      acc[index] = [acc[index][0], acc[index][1] + item[1]];
      return acc;
    }, _(_.union(cats, [["Autres", 0]])).map(d => [d[0], 0]).value())
  )
  .filter(i => i[1] > 0) // Retire les catégories tarifaires sans tickets vendus
  .value();
}




/**
  * tarifCat
  * A partir de nombres de billets vendus par code tarifaire, on obtient le nombre de billets vendus par catégorie tarifaire (regroupement de codes tarifaires)
  * @param tarif {Object} Clé : code tarifaire, valeur : nombre de billets
  * @param cats {Object} Liste de catégories tarifaires
  */
// function tarifCat (tarif, cats) {
//   return _(tarif)
//   .map((v, k) => {
//     return _.fromPairs([[
//       _(cats).findKey(c => _.indexOf(c, parseInt(k, 10)) > -1) || "Autres",
//       v
//     ]]);
//   })
//   .reduce((acc, item) => { // NB : transform = reduce, mais renvoie un objet lodash
//     return _({}).assignWith(acc, item, (a, b) => _.sum([a, b])).value();
//   });
// }


    </script>
    <title></title>
  </head>
  <body>
    <pre><code></code></pre>
  </body>
</html>